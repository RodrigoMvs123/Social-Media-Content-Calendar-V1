name: PR Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        cd client && npm ci
        cd ../server && npm ci
    
    - name: Check for breaking changes
      id: breaking-changes
      run: |
        echo "Checking for potential breaking changes..."
        
        # Check for database schema changes
        if git diff --name-only origin/main...HEAD | grep -E "(init-database|schema|migration)" > /dev/null; then
          echo "breaking=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Database schema changes detected"
        else
          echo "breaking=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Build and test
      run: |
        echo "ðŸ—ï¸ Building frontend..."
        cd client && npm run build
        
        echo "ðŸ§ª Running tests..."
        cd ../server && npm test --if-present || echo "No tests configured"
      env:
        NODE_ENV: test
        DB_TYPE: sqlite
        DB_PATH: ./test.sqlite
        JWT_SECRET: test-secret
    
    - name: Check bundle size
      id: bundle-size
      run: |
        cd client
        if [ -f "dist/assets/index-*.js" ]; then
          size=$(du -h dist/assets/index-*.js | cut -f1)
          echo "Bundle size: $size"
          echo "size=$size" >> $GITHUB_OUTPUT
        fi
    
    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const breaking = '${{ steps.breaking-changes.outputs.breaking }}';
          const bundleSize = '${{ steps.bundle-size.outputs.size }}';
          
          let comment = '## ðŸ¤– PR Validation Results\n\n';
          comment += 'âœ… **Build Status**: Passed\n';
          comment += `ðŸ“¦ **Bundle Size**: ${bundleSize || 'N/A'}\n`;
          
          if (breaking === 'true') {
            comment += '\nâš ï¸ **Breaking Changes Detected**\n';
            comment += 'This PR contains potential database schema changes. Please review carefully.\n';
          }
          
          comment += '\n---\n';
          comment += '*Automated by GitHub Actions*';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  size-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check repository size
      run: |
        echo "ðŸ“Š Repository size analysis:"
        du -sh . || true
        echo ""
        echo "ðŸ“ Largest directories:"
        du -sh */ 2>/dev/null | sort -hr | head -10 || true