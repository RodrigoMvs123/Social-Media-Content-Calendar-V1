name: Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Update service configuration
      run: |
        curl -X PATCH "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}" \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
            "serviceDetails": {
              "envSpecificDetails": {
                "buildCommand": "npm install && cd client && npm install && npm run build && cd ../server && npm install",
                "startCommand": "cd server && node init-database.js && npm run start"
              }
            }
          }'
    
    - name: Deploy to Render
      uses: johnbeynon/render-deploy-action@v0.0.8
      with:
        service-id: ${{ secrets.RENDER_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}
    
    - name: Wait for deployment
      run: sleep 60
    
    - name: Health check
      run: |
        echo "Checking deployment health..."
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.RENDER_SERVICE_URL }}/api/health || echo "000")
        if [ "$response" = "200" ]; then
          echo "‚úÖ Deployment successful - Health check passed"
        else
          echo "‚ùå Deployment failed - Health check returned: $response"
          exit 1
        fi
    
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "üöÄ Deployment to production completed successfully!"
        else
          echo "üí• Deployment to production failed!"
        fi